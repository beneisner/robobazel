licenses(["notice"])

genrule(
    name = "configure",
    srcs = [
        "autogen.sh",
        "bootstrap.sh",
        "configure.ac",
        "libusb/version.h",
        "Makefile.am",
        "libusb/Makefile.am",
        "NEWS",
        "README",
        "AUTHORS",
        "ChangeLog",
        "libusb-1.0.pc.in",
        "doc/doxygen.cfg.in",
        "doc/Makefile.am",
        "examples/Makefile.am",
        "tests/Makefile.am",
        "libusb/core.c",
    ],
    outs = ["config.h"],
    cmd = """
        cd external/libusb && \
        mkdir -p $(@D) && \
        bash -c ./autogen.sh > /dev/null 2>&1 && \
        cd ../.. && \
        cp external/libusb/config.h $(location config.h) && \
        ls $(@D)
    """
    # found https://github.com/bazelbuild/bazel/issues/2532#issuecomment-280685727
    # https://github.com/bazelbuild/bazel/issues/6344
)

cc_library(
    name = "libusb_darwin",
    srcs = [
        "libusb/os/threads_posix.h",
        "libusb/os/threads_posix.c",
        "libusb/os/poll_posix.h",
        "libusb/os/poll_posix.c",
        "libusb/os/darwin_usb.h",
        "libusb/os/darwin_usb.c",
        "libusb/libusbi.h",
        "libusb/libusb.h",
        "libusb/version.h",
        "libusb/version_nano.h",
	    "libusb/core.c",
        "libusb/descriptor.c",
        "libusb/hotplug.h",
        "libusb/hotplug.c",
        "libusb/io.c",
        "libusb/strerror.c",
        "libusb/sync.c",
        ":config.h",
    ],
    includes = ["./", "./libusb"],
    hdrs = ["libusb/libusb.h"],
)

cc_binary(
    name = "tests",
    deps = [":libusb_darwin"],
    linkopts = ["-framework IOKit"],
    srcs = [
        "tests/stress.c",
        "tests/libusb_testlib.h",
        "tests/testlib.c",
    ],
)